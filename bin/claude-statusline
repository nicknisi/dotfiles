#!/usr/bin/env bash

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
RESET='\033[0m'

# Read JSON input from stdin
input=$(cat)

# Helper functions for extracting data
get_model_name() { echo "$input" | jq -r '.model.display_name // "Unknown Model"'; }
get_output_style() { echo "$input" | jq -r '.output_style.name // "default"'; }
get_current_dir() { echo "$input" | jq -r '.workspace.current_dir // "."'; }
get_project_dir() { echo "$input" | jq -r '.workspace.project_dir // "."'; }
get_cost() {
  local cost=$(echo "$input" | jq -r '.cost.total_cost_usd // 0')
  printf "\$%.2f" "$cost"
}

# Extract values
model=$(get_model_name)
output_style=$(get_output_style)
current_dir=$(get_current_dir)
project_dir=$(get_project_dir)
cost_display=$(get_cost)

# Get project name and handle subdirectory display
project=$(basename "$project_dir")
if [ "$current_dir" != "$project_dir" ]; then
  subdir=$(basename "$current_dir")
  project="${project} (CWD: ${subdir}/)"
fi

# Get git branch
git_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "no-git")

# Build statusline with colors
statusline=""
statusline+="${BLUE}ğŸ“ ${project}${RESET}"
statusline+=" ${WHITE}|${RESET} "
statusline+="${GREEN}ğŸŒ¿ ${git_branch}${RESET}"
statusline+=" ${WHITE}|${RESET} "
statusline+="${MAGENTA}ğŸ§  ${model}${RESET}"
statusline+=" ${WHITE}|${RESET} "
statusline+="${YELLOW}ğŸ¨ ${output_style}${RESET}"
statusline+=" ${WHITE}|${RESET} "
statusline+="${CYAN}ğŸ’° ${cost_display}${RESET}"

echo -e "$statusline"
