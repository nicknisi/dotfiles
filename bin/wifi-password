#!/usr/bin/env bash

# wifi-password: Retrieve WiFi password from macOS keychain
# Usage: wifi-password [--system] [--quiet] [SSID]
#
# Flags:
#   --system   Also search System keychain (may prompt for sudo)
#   --quiet    Suppress informational messages

set -euo pipefail

# Initialize options
search_system_keychain=false
quiet_mode=false
target_ssid=""

# Parse command-line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --system) search_system_keychain=true ;;
    --quiet)  quiet_mode=true ;;
    *)        target_ssid="$1" ;;
  esac
  shift
done

# Get current WiFi SSID if none specified
if [[ -z "$target_ssid" ]]; then
  # Get the current WiFi network name on macOS
  target_ssid="$(networksetup -getairportnetwork en0 2>/dev/null | sed -n 's/Current Wi-Fi Network: //p')"

  if [[ -z "$target_ssid" ]]; then
    echo "Error: Not connected to WiFi or unable to detect network" >&2
    exit 2
  fi
fi

# Function to attempt password retrieval
try_keychain() {
  local password
  password="$("$@" 2>/dev/null)" || return 1

  if [[ -n "$password" ]]; then
    printf "%s\n" "$password"
    return 0
  fi
  return 1
}

# Try login keychain (no popup) - most specific search first
if try_keychain security find-generic-password \
                -D "AirPort network password" \
                -a "$target_ssid" \
                -gw; then
  exit 0
fi

# Try broader search in login keychain
if try_keychain security find-generic-password \
                -s "$target_ssid" \
                -gw; then
  exit 0
fi

# Try System keychain if requested
if [[ "$search_system_keychain" == true ]]; then
  # Try with sudo -n first (no password prompt)
  if sudo -n true 2>/dev/null && \
     try_keychain sudo security find-generic-password \
                  -D "AirPort network password" \
                  -a "$target_ssid" \
                  -gw; then
    exit 0
  fi

  # Try with sudo (will prompt if needed)
  if try_keychain sudo security find-generic-password \
                  -D "AirPort network password" \
                  -a "$target_ssid" \
                  -gw; then
    exit 0
  fi
elif [[ "$quiet_mode" == false ]]; then
  echo "Password may be in the System keychain. Re-run with --system to query it (may prompt)." >&2
fi

# Password not found
exit 2